apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mon

namePrefix: mon-

generatorOptions:
  disableNameSuffixHash: true

resources:
  # Pulled from https://github.com/prometheus-operator/prometheus-operator/blob/v0.67.1/bundle.yaml
  # Version of Operator will depend on bundle we download and replace here. 
  # Only startegic overlaying/patching our desired base images and more further below. 
  - bundle.yaml

patches:
- target:
    kind: CustomResourceDefinition
  patch: |-
    apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    metadata:
      name: not-used-to-match-or-patch
      annotations:
        argocd.argoproj.io/sync-options: ServerSideApply=true
        argocd.argoproj.io/sync-wave: "-1"

- target:
    kind: Deployment
    name: prometheus-operator
  patch: | 
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: prometheus-operator
    spec:
      template:
        spec:
          containers:
          - args:
            - --kubelet-service=kube-system/kubelet
            - --prometheus-config-reloader=artifactory.ssnc.dev/quay.io/prometheus-operator/prometheus-config-reloader:v
            - --prometheus-default-base-image=artifactory.ssnc.dev/quay.io/prometheus/prometheus
            - --namespaces=mon
            image: artifactory.ssnc.dev/quay.io/prometheus-operator/prometheus-operator:v
            name: prometheus-operator

replacements:
- source:
    kind: Deployment
    name: prometheus-operator
    fieldPath: metadata.labels.[app.kubernetes.io/version]
  targets:
  - select:
      kind: Deployment
      name: prometheus-operator
    fieldPaths:
    - spec.template.spec.containers.[name=prometheus-operator].image
    options:
      delimiter: ':v'
      index: 1
  - select:
      kind: Deployment
      name: prometheus-operator
    fieldPaths:
    - spec.template.spec.containers.[name=prometheus-operator].args.[=--prometheus-config-reloader*]
    options:
      delimiter: ':v'
      index: 1

